# Die H√§ufigkeitsanalyse kategorialer Daten {#haeufigkeit-kategorial}

## üì¢ Zielsetzung dieser Einheit {.unnumbered}

In dieser Einheit wollen wir uns mit der uni- und bivariaten H√§ufigkeitsanalyse kategorialer Daten besch√§ftigen. Ausgehend von einem Beispiel zur Wahrnehmung von COVID-19 Schutzma√ünahmen werden wir dazu

-   Strategien zur Datenvalidierung;

-   sowie numerische und graphische Vorgehensweise zur H√§ufigkeitsanalyse kategorialer Variablen erproben.

```{r echo=FALSE, purl=FALSE}
myScriptname <- "07_n_kategoriale_variablen"

knitr::asis_output(paste(
  "<p><strong>tl;dr: </strong>",
  "<a href=\"https://kamihoeferl.at/lehre/vu_sozwiss_1/",
  myScriptname,
  ".R\" type=\"application/octet-stream\">Her mit dem Code!</a></p>",
  sep = ""))
```

---


## Kategoriale Daten auswerten {#katdatasetup}

Auch f√ºr **nominale und ordinale Daten** - oftmals zusammenfassend als **kategoriale Daten** bezeichnet - steht uns eine Reihe von Analysem√∂glichkeiten zur Verf√ºgung. Diese wollen wir uns hier anhand des folgenden Beispieldatensatzes genauer ansehen:

Im Auftrag des Presse- und Informationsamts der Deutschen Bundesregierung wurden seit Kalenderwoche 12/2020 laufend repr√§sentative [Bev√∂lkerungsbefragungen zum Thema "Corona-Krise"](https://dbk.gesis.org/dbksearch/GDesc2.asp?list=&search=&search2=&field=&field2=&jahr=&operator=&bool=&bool2=&maxRec=&sort=&DB=d&no=0205) durchgef√ºhrt. Eine dieser Befragungen wollen wir uns n√§her ansehen:

üëâ <https://search.gesis.org/research_data/ZA7677>

Die Daten (inkl. Fragebogen etc.) dieser Befragung aus der Kalenderwoche 45/2020 wurden dem gesis-Repositorium des Leibniz-Instituts f√ºr Sozialwissenschaften entnommen und k√∂nnen üëâ [hier als ZIP-Datei geladen](data/Trendfragen_Corona_45-20.zip) werden.

Nach dem Download extrahieren wir diese Daten in den Ordner "Trendfragen_Corona_45-20" in unserem "data"-Verzeichnis:

        Projektfolder
        | skript_1.R
        | ...
        | skript_n.R    
        +-- data
            +-- Trendfragen_Corona_45-20
                | GESIS-Suche- Trendfragen Corona (Woche 45-2020).url
                | ...
                | ZA7677_v1-0-0.csv
            | datensatz_1.csv
            | ...
            | datensatz_n.csv

Wie uns der [Fragebogen (data/ZA7677_fb.pdf)](data/Trendfragen_Corona_45-20/ZA7677_fb.pdf) verr√§t, wurde eine Vielzahl an Merkmalen abgefragt. Aus dieser Vielzahl picken wir uns diese beiden Merkmale heraus:

-   **Frage Nr. 5: Die beurteilte Angemessenheit der Ma√ünahmen zur Pandemiebek√§mpfung**\
    Wie sch√§tzen Sie die aktuellen politischen Ma√ünahmen ein, um das Corona-Virus einzud√§mmen: Sind diese getroffenen Ma√ünahmen Ihrer Meinung nach angemessen, gehen sie zu weit oder gehen sie nicht weit genug?

-   **Frage s8: Die Politische Orientierung**\
    Diese Frage zielt auf das Wahlverhalten der befragten Person der letzten Bundestagswahl ab. Wie genau dieses Wahlverhalten abgefragt wurde ist jedoch nicht dokumentiert üò¢.

**Ziel unserer Analyse** soll sein herauszufinden,

1.  wie sich die beiden Merkmale √ºber die Befragten verteilen;

2.  wie sich die Verteilung dieser beiden Merkmale zueinander verh√§lt.

## Vorbereitendes

Bevor wir uns die Befragungsdaten selbst genauer ansehen, laden wir zun√§chst das [Package tidyverse](https://www.tidyverse.org). Dieses Package besteht wiederum aus mehreren Packages, welche die Analyse von Daten erleichtern und nachvollziehbarer gestalten sollen.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

> üìö **Exkurs:**\
> Das Sammelpackage tidyverse bietet viele praktische Funktionalit√§ten, beispielsweise werden wir die sgn. [Pipes (= Weiterleitungen) des dplyr-Packages](https://style.tidyverse.org/pipes.html) nutzen. Mit Pipes kann Code √ºbersichtlicher gestaltet werden, indem Ergebnisse einer Berechnung direkt als Input f√ºr einen anderen Schritt genutzt werden:

```{r}
somedata <- data.frame(zahlen = c(1,2,3,4,5,6,7,8,9,10))

# statt:
mean(somedata$zahlen)

# geht jetzt:
somedata %>%
  summarise(mean(zahlen))
# und das:
somedata %>%
  summarise(Durchschnitt = mean(zahlen),
            Median = median(zahlen))
# und das:
somedata %>%
  summary(.)
```

## Der Datenimport, die Datenaufbereitung und -validierung {#katdatamanipul}

Der Import der Daten ist schnell erledigt:

```{r}
Trendfragen <- as_tibble(read.csv2("data/Trendfragen_Corona_45-20/ZA7677_v1-0-0.csv",
                                   encoding = "UTF-8"))
```

Ein erster Blick auf diese verr√§t uns, dass den einzelnen Beobachtungen (= Zeilen) noch keine **eindeutigen IDs** zugewiesen wurden. Das ist durchaus praktisch, um im weiteren Verlauf einer Analyse einzelne Beobachtungen (aka. Records oder ebene Zeilen) direkt ansprechen zu k√∂nnen. Um dies nachzuholen nummerieren wir noch einmal alle Records durch:

```{r}
Trendfragen <- Trendfragen %>%
  mutate(id = row_number())
```

Nun wollen wir den Datensatz etwas **ausd√ºnnen** - sprich unsere Variablen von Interesse (bcor5 und s8) ausfiltern und deren **Skalenniveau** setzen (= in Factors √ºberf√ºhren):

```{r}
df <- Trendfragen %>%
  select(id, bcor5, s8) %>%
  mutate(bcor5 = as.factor(bcor5), s8 = as.factor(s8))    # oder:
  # mutate(across(c(bcor5, s8), factor))                  # oder:
  # mutate(across(where(is.character), factor))

glimpse(df)
```

Dann wollen wir noch √ºberpr√ºfen, ob sich nicht fehlende Werte - in der R-Logik sgn. **NAs** oder "Not Available"-Werte - eingeschlichen haben. Dazu k√∂nnen wir f√ºr jede unserer Variablen von Interesse die vorhandenen Merkmalsauspr√§gungen z√§hlen lassen:

```{r}
table(df$bcor5)
# oder:
df %>%
  count(s8)
```

Vor allem bei kontinuierlichen Variablen ist diese Vorgehensweise aber suboptimal. Flotter geht es mit:

```{r}
colSums(is.na(df))

# alternativ:
df %>%
  summarise(across(everything(), list(n_miss = ~ sum(is.na(.x)))))
```

Sieht gut aus - wir haben keine fehlenden (= NA) Werte. Ein Blick auf den Besatz der Kategorien der Frage s8 zum Wahlverhalten zeigt uns das **Vorhandensein der Kategorie "-1"**. Diese kann Nichtw√§hlerInnen kennzeichnen, was wir aber mangels Dokumentation nicht wissen k√∂nnen üò¢. Der √úbung halber wollen wir alle **Records ausschlie√üen**, die bei Frage s8 die **Merkmalsauspr√§gung "-1"** aufweisen:

```{r}
df2 <- df %>%
  filter(s8 != "-1") %>%
  mutate(s8 = droplevels(s8))

df2 %>%
  count(s8) %>%
  arrange(n)
  # arrange(desc(n))    # oder:
  # arrange(-n)
```

## Die H√§ufikgeitsanalyse einer Variablen

Damit k√∂nnen wir nun unsere erste Frage in Angriff nehmen:\
Wie werden aktuelle **Ma√ünahmen zu Pandemiebek√§mpfung in Deutschland beurteilt**. Einen erste Ann√§herung an diese Frage erhalten wir hiermit:

```{r}
table(df2$bcor5)
prop.table(table(df2$bcor5))
```

Einen kompakteren √úberblick auf die **absoluten und relativen** Gewichte der Merkmalsauspr√§gungen kann man mithilfe des [dplyr-Packages](https://cran.r-project.org/web/packages/dplyr/index.html) gewinnen:

```{r}
df2 %>%
  group_by(bcor5) %>%
  summarise(n = n()) %>%
  mutate(relFreq = n / sum(n)) %>%
  mutate(relFreq = round(relFreq, 2)) %>%
  arrange(-relFreq)
```

Wir sehen, dass mehr als 60% aller Befragten die gesetzten Ma√ünahmen zur Pandemiebek√§mpfung als ausreichend und jeweils ein schwaches F√ºnftel diese Ma√ünahmen entweder als zu weitgehend oder als nicht weitgehend genug ansehen.

Nachdem wir nun unsere erste Frage numerisch gel√∂st haben, wollen wir uns auch an einer **graphischen L√∂sung** versuchen:

```{r}
# cheap trick:
ggplot(df2, aes(x = s8, y = ..count.., group = 1)) +
  geom_bar()
```

Irgendwie schon und auch wieder nicht. Next try:

```{r}
# more shiny:
ggplot(df2, aes(x = forcats::fct_infreq(s8), y = ..count.., group = 1)) +
  geom_bar(fill = "blue", color = "black") +
  coord_flip() +
  labs(title = "Catchy Titel",
     subtitle = "Was noch gesagt werden sollte",
     x = "Polit. Orientierung\nletzte Bundestagswahl\n",
     y = "\nabs. Anzahl",
     caption = "\n(Daten: Presse- und Informationsamt der Deutschen Bundesregierung, 2021)") +
  theme_bw() +
  theme(text = element_text(size = 11),
        plot.caption = element_text(hjust = 0.5))
```

Oder:

```{r message=FALSE}
# anders shiny:
library(scales)   # zum Formatieren der Achsen etc.

ggplot(df2, aes(x = forcats::fct_infreq(s8), y = ..prop.., group = 1)) +
  geom_bar(fill = "red") +
  labs(title = "Wieder ein catchy Titel",
     subtitle = "Was noch immer gesagt werden sollte",
     x = "\n Polit. Orientierung bei letzter Bundestagswahl",
     y = "Anteile [%]\n",
     caption = "\n(Daten: Presse- und Informationsamt der Deutschen Bundesregierung, 2021)") +
  scale_y_continuous(labels = percent) +
  theme_bw() +
  theme(text = element_text(size = 11),
        axis.text.x=element_text(angle = 45, hjust = 1),
        plot.caption = element_text(hjust = 0.5))
```

Oder:

```{r}
# ein letztes mal anders shiny:
library(RColorBrewer)   # Sammlung von diskreten& kontinuierlichen Farbpaletten
display.brewer.all()

ggplot(df2, aes(x = "", y = ..count.., fill = forcats::fct_rev(forcats::fct_infreq(s8)))) +
  geom_bar(position = "fill", color = "black") +
  coord_polar("y", start=0, direction = 1) +
  scale_y_continuous(labels = percent) +
  # scale_fill_brewer(palette = "Set1") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank()) +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(title = "Catchy Titel",
     subtitle = "Was noch gesagt werden sollte",
     caption = "\n(Daten: Presse- und Informationsamt der Deutschen Bundesregierung, 2021)",
     fill = "polit. Ausrichtung")
```

You get it. Das [**ggplot2-Package**](https://ggplot2.tidyverse.org) **bietet unendlich viele M√∂glichkeiten**, sich in der Gestaltung von Abbildungen zu verlieren. Drei gute Startpunkte f√ºr die eigene weitere Auseinandersetzung damit:

-   Hadley Wickhams Buch "ggplot2 - Elegant Graphics for Data Analysis": <https://ggplot2-book.org>

-   Die R Graph Gallery: <https://www.r-graph-gallery.com/ggplot2-package.html>

-   STHDAs "Be Awesome on ggplot2: <http://www.sthda.com/english/wiki/be-awesome-in-ggplot2-a-practical-guide-to-be-highly-effective-r-software-and-data-visualization>


## Die H√§ufigkeitsanalyse zweier kategorialer Variablen {#katdatabivarn}

Am Beginn dieser Einheit haben wir uns zwei Ziele f√ºr diese Analyse gesetzt:

Wir wollten wissen, wie die Befragten Ma√ünahmen zur Pandemiebek√§mpfung in Deutschland beurteilen (**Frage bcor5**) und welche politischen Positionen diese vertreten (**Frage s8**). Diese beiden Teilfragen haben wir ja bereits behandelt. Ob sich die Beurteilung der Ma√ünahmen zur Pandemiebek√§mpfung mit der politischen Ausrichtung √§ndert oder nicht - who knows? üòâ

Die Antwort auf diese letzte Frage ist einfach: Wir nat√ºrlich! Dazu wollen wir uns zun√§chst eine einfache **Kontingenztabelle** mit den beiden Variablen **bcor5 und s8** basteln:

```{r}
table(df2$bcor5, df2$s8)

table(df2$bcor5, df2$s8) %>%
  prop.table(., margin = 2) %>%   # 2 ... Spaltenprozent
  round(., 2)
```

Betrachtet man bei jeder Partei den relativen Besatz der Kategorien "angemessen" und "gehen zu weit", fallen gro√üe Unterschiede auf: W√§hrend die H√§lfte der AFD-orientierten Befragten die Ma√ünahmen als zu weitreichend einstufen, tun dies gerade einmal 11% der gr√ºn-orientierten Befragten. Die politische Orientierung und die Beurteilung der Ma√ünahmen zur Pandemiebek√§mpfung in Deutschland scheinen also miteinander zu korrelieren.

> üìö **Exkurs:**\
> Wie immer gibt es viele Wege [mit R eine Kontingenztabelle zu erzeugen](https://cran.r-project.org/web/packages/janitor/vignettes/tabyls.html). Beispielsweise etwas ungelenk (= l√§ngerer Code, nur Summenprozent) mittels des dplyr-Packages:

```{r}
df2 %>%
  group_by(bcor5, s8) %>%
  summarise(n = n(), .groups = "drop") %>%
  spread(c(s8), c(n))

df2 %>%
  group_by(bcor5, s8) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(relFreq = n / sum(n)) %>%
  mutate(relFreq = round(relFreq, 2)) %>%
  subset(select = c(bcor5, s8, relFreq)) %>%
  spread(c(s8), c(relFreq))
```

> Eleganter geht es mit zum Beispiel mit dem [janitor-Package](https://garthtarr.github.io/meatR/janitor.html):

```{r}
library(janitor)
janitor::tabyl(df2, bcor5, s8) %>%
  adorn_totals(c('row')) %>%
  adorn_percentages('col') %>% 
  adorn_pct_formatting(digits = 0) %>%
  # adorn_ns() %>%
  adorn_title('combined') %>%
  knitr::kable()
```

Nach der numerischen wollen wir nat√ºrlich auch wieder eine **graphische L√∂sung**. Wir starten wieder mit der Minimalvariante:

```{r}
ggplot(df2, aes(x = s8, fill = bcor5)) +
  geom_bar()
```

Na ja, noch nicht ganz. Ein neuer Anlauf:

```{r}
ggplot(df2, aes(x = s8, fill = bcor5)) +
  geom_bar(position = "fill", color = "black", width = 0.7) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), 
      plot.subtitle = element_text(hjust = 0.5),
      plot.caption = element_text(hjust = 0.5),
      panel.grid.major.x = element_line(color = "gray")) +
  labs(title = "Catchy Titel",
   subtitle = "Was noch gesagt werden sollte\n",
   caption = "\n(Daten: Presse- und Informationsamt der Deutschen Bundesregierung, 2021)",
   x = "polit. Aursrichtung\n",
   y = "",
   fill = "Beurteilung\nMa√ünahmen") +
  guides(fill = guide_legend(reverse = TRUE))
```

> üìö **Ein Exkurs f√ºr PerfektionistInnen:**\
> Die **Sortierung der Kategorienachse "polit. Ausrichtung"** k√∂nnte noch optimiert werden, um LerserInnen beispielsweise die politischen Ausrichtungen (Variable bcor5) anhand der Angemessenheit der Ma√ünahmen (Auspr√§gung "angemessen") absteigend darzustellen:

```{r}
# Kontingenztabelle ermitteln & als Dataframe ablegen
konttab <- table(df2$bcor5, df2$s8) %>%
  prop.table(., margin = 2) %>%   # 2 ... Spaltenprozent
  round(., 2) %>%
  as.data.frame()

# gew√ºnschte Reihenfolge herstellen & ablegen: 
# Beurteilung angemessen absteigend nach rel. H√§ufigkeit
vis.order <- konttab %>%
  filter(Var1 == "angemessen") %>%
  arrange(Freq) %>%
  select(Var2)
vis.order.vector <- as.character(vis.order$Var2)

# Datensatz f√ºr Visualisierung vorbereiten
vis.data.1 <- df2
vis.data.1$s8 <- factor(df2$s8, levels = vis.order.vector)

# Plotten
ggplot(vis.data.1, aes(x = s8, fill = forcats::fct_rev(bcor5))) +
  geom_bar(position = "fill", color = "black", width = 0.7) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      plot.caption = element_text(hjust = 0.5),
      panel.grid.major.x = element_line(color = "gray")) +
  labs(title = "Catchy Titel",
   subtitle = "Was noch gesagt werden sollte\n",
   caption = "\n(Daten: Presse- und Informationsamt der Deutschen Bundesregierung, 2021)",
   x = "polit. Aursrichtung\n",
   y = "",
   fill = "Beurteilung\nMa√ünahmen") +
  guides(fill = guide_legend(reverse = TRUE))
```

------------------------------------------------------------------------

üèÜ **Nun wissen wir, ...**

-   wie wir mittels des Tidyverse-Packages **gut lesbaren Code und Abbildungen** erstellen k√∂nnen.
-   wie wir **Datens√§tze filtern** k√∂nnen.
-   wie wir uni- und bivariate **H√§ufikgeitsauswertungen tabellarisch und graphisch** vornehmen k√∂nnen.
-   dass es in R immer viele Wege gibt, um sein Ziel zu erreichen üòé.

Lassen Sie uns nun in die **Zusammenh√§nge zwischen kategorialen Variablen** eintauchen ...

![](images/warmup_1.gif){.videoframe width="250"}
